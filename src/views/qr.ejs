<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsBot QR Code</title>
    <link rel="icon" href="/public/favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .checking {
            background-color: #f0f0f0;
            color: #666;
        }

        .waiting {
            background-color: #fff3cd;
            color: #856404;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>

<body>
    <div align="center">
        <div id="qrCodeData">
            <h3>ü§ñ WhatsBot : Scan the QR Code to Continue! </h3>
            <% if (qrCodeData) { %>
                <img src="https://api.qrserver.com/v1/create-qr-code/?data=<%= encodeURIComponent(qrCodeData) %>&size=300x300"
                    alt="QR Code" />
                <p>üì± Open WhatsApp on your phone and scan this QR code</p>
                <% } else { %>
                    <img src="/public/loader.svg" alt="Loader" width="100" height="100" />
                    <p>Hold on a sec while the QR code is being generated.</p>
                    <% } %>
                        <div id="status" class="checking">Checking status...</div>
        </div>
        <script>
            let lastQrCode = '';
            const statusDiv = document.getElementById('status');

            const checkQrStatus = () => {
                fetch('/qr-status')
                    .then(response => response.json())
                    .then(data => {
                        console.log('QR Status:', data);

                        // If the QR code has changed, reload the page to show the new one
                        if (data.qrCodeData && data.qrCodeData !== lastQrCode) {
                            lastQrCode = data.qrCodeData;
                            statusDiv.className = 'waiting';
                            statusDiv.textContent = '‚è≥ Waiting for QR code scan...';
                            location.reload();
                        }

                        // If authenticated successfully, redirect to the main page
                        if (data.qrScanned) {
                            console.log('QR scanned! Redirecting...');
                            statusDiv.className = 'success';
                            statusDiv.textContent = '‚úÖ Authentication successful! Redirecting...';
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1000);
                        } else if (data.qrCodeData) {
                            statusDiv.className = 'waiting';
                            statusDiv.textContent = '‚è≥ Waiting for QR code scan...';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking QR status:', error);
                        statusDiv.className = 'checking';
                        statusDiv.textContent = '‚ö†Ô∏è Connection error, retrying...';
                    });
            };

            // Check status every 3 seconds
            setInterval(checkQrStatus, 3000);

            // Check immediately on load
            checkQrStatus();
        </script>
    </div>
</body>

</html>